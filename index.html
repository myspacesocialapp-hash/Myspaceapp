<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Space</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons (for modern icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* All the CSS from the previous file goes here */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            -webkit-tap-highlight-color: transparent;
        }
        .page { display: none; }
        .page.active { display: block; }
        .nav-btn {
            flex: 1; padding-top: 8px; padding-bottom: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px; color: #64748b; transition: all 0.2s ease-in-out;
        }
        .nav-btn.active { color: #2563eb; font-weight: 600; }
        .nav-btn i { font-size: 24px; margin-bottom: 2px; }
        .auth-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .story-reel {
            display: flex; overflow-x: auto; padding: 12px 0;
            gap: 12px; white-space: nowrap; -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .story-reel::-webkit-scrollbar { display: none; }
        .story-item { cursor: pointer; width: 72px; flex-shrink: 0; }
        .story-avatar {
            height: 64px; width: 64px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            padding: 3px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }
        .story-avatar img {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 50%; border: 2px solid white;
        }
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.3s ease;
        }
        .loader {
            width: 48px; height: 48px; border: 5px solid #FFF;
            border-bottom-color: #2563eb; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 500px;
        }
    </style>
</head>
<body class="w-full max-w-xl mx-auto bg-white">

    <!-- Global Containers -->
    <div id="loading-overlay" class="hidden"><div class="loader"></div></div>
    
    <!-- Auth Container (Login/Sign Up) -->
    <div id="auth-container" class="page active w-full min-h-screen flex flex-col items-center justify-center p-4 auth-gradient">
        <!-- Auth content will be injected by JS -->
    </div>

    <!-- Main App Container (Holds all pages after login) -->
    <div id="app-container" class="page w-full min-h-screen bg-gray-100">
        <!-- Page Content will be dynamically inserted here -->
        <div id="page-content" class="p-4" style="padding-bottom: 80px;">
            <!-- This is where pages like Feed, Friends, Profile, etc. are rendered -->
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 w-full max-w-xl mx-auto bg-white border-t border-gray-200 flex justify-around items-center h-16">
            <button data-page="feed" class="nav-btn"><i class="ph-bold ph-house"></i><span data-lang-key="nav_feed">Feed</span></button>
            <button data-page="friends" class="nav-btn"><i class="ph-bold ph-users-three"></i><span data-lang-key="nav_friends">Friends</span></button>
            <button data-page="messages" class="nav-btn"><i class="ph-bold ph-chats"></i><span data-lang-key="nav_messages">Messages</span></button>
            <button data-page="profile" class="nav-btn"><i class="ph-bold ph-user"></i><span data-lang-key="nav_profile">Profile</span></button>
        </nav>
    </div>

    <!-- 
      MODALS 
      These are hidden by default and shown when needed.
    -->

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal hidden">
        <div class="modal-content text-center">
            <p id="alert-message" class="mb-6 text-lg"></p>
            <button id="alert-ok-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="btn_ok">OK</button>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="comment-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" data-lang-key="title_comments">Comments</h2>
            <div id="comment-list" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
            <textarea id="comment-input" class="w-full p-2 border border-gray-300 rounded-lg" data-lang-key="placeholder_comment"></textarea>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="comment-cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg" data-lang-key="btn_cancel">Cancel</button>
                <button id="comment-submit-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="btn_submit">Submit</button>
            </div>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="story-viewer-modal" class="modal hidden flex-col p-4">
        <div id="story-progress-bar" class="w-full h-1 bg-gray-500 rounded-full mb-2">
            <div id="story-progress" class="h-1 bg-white rounded-full"></div>
        </div>
        <img id="story-image" src="" class="w-full h-auto rounded-lg" alt="Story">
        <button id="story-close-btn" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal hidden">
        <div class="modal-content flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 id="chat-with-name" class="text-xl font-bold">Chat</h2>
                <button id="chat-close-btn" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="chat-messages" class="flex-grow space-y-3 overflow-y-auto mb-4 p-2 bg-gray-50 rounded-lg flex flex-col">
                <!-- Messages will be injected here -->
            </div>
            <div class="flex space-x-2">
                <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-lg" data-lang-key="placeholder_message">
                <button id="chat-send-btn" class="bg-blue-600 text-white font-semibold p-3 rounded-lg"><i class="ph ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- 
      JAVASCRIPT (Firebase, Cloudinary, and App Logic)
    -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, serverTimestamp, setDoc, getDoc, updateDoc, orderBy, where, arrayUnion, arrayRemove, runTransaction, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // --- ⬇️ (STEP 2) PASTE YOUR FIREBASE CONFIG HERE ⬇️ ---
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyClhomaPlXVrk_xeD0_jXHx3x1IPzvHH0s",
            authDomain: "my-space-app-9d39e.firebaseapp.com",
            projectId: "my-space-app-9d39e",
            storageBucket: "my-space-app-9d39e.firebasestorage.app",
            messagingSenderId: "567017323339",
            appId: "1:567017323339:web:78cb093d20e6090da806ce"
        };
        
        // ===================================================================================
        // --- ⬇️ (STEP 3) PASTE YOUR CLOUDINARY CLOUD NAME HERE ⬇️ ---
        // ===================================================================================
        const CLOUD_NAME = "deobpcudu"; 
        const UPLOAD_PRESET = "myuploads"; // This is already correct
        // ===================================================================================

        // --- GLOBAL VARIABLES & STATE ---
        let auth, db, currentUserId, currentUserData;
        let currentLang = 'en'; // Default language
        let currentOpenChatId = null;
        let currentOpenPostId = null;
        let unsubscribeUser, unsubscribePosts, unsubscribeStories, unsubscribeAllUsers, unsubscribeRequests, unsubscribeChats, unsubscribeTickets, unsubscribeComments, unsubscribeChatMessages;

        // --- DOM ELEMENT SELECTORS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Containers
        const authContainer = $('#auth-container');
        const appContainer = $('#app-container');
        const pageContent = $('#page-content');
        const loadingOverlay = $('#loading-overlay');
        
        // Modals
        const alertModal = $('#alert-modal');
        const commentModal = $('#comment-modal');
        const storyViewerModal = $('#story-viewer-modal');
        const chatModal = $('#chat-modal');

        // --- TRANSLATION (LANGUAGE) SYSTEM ---
        const translations = {
            'en': {
                'login_title': 'Welcome to My Space', 'login_subtitle': 'Login to connect.',
                'signup_title': 'Create Your Account', 'signup_subtitle': 'Join the community.',
                'nav_feed': 'Feed', 'nav_friends': 'Friends', 'nav_messages': 'Messages', 'nav_profile': 'Profile',
                'placeholder_username': 'Choose a Username', 'placeholder_email': 'Email Address', 'placeholder_password': 'Password (min. 6 characters)',
                'btn_login': 'Login', 'btn_signup': 'Sign Up',
                'toggle_signup': "Don't have an account?", 'toggle_login': 'Already have an account?',
                'create_post_title': 'Create a Post', 'placeholder_post': "What's on your mind?",
                'btn_add_photo': 'Add Photo', 'btn_post': 'Post',
                'story_you': 'Your Story',
                'friends_title': 'Find Friends', 'friends_requests': 'Friend Requests', 'friends_my': 'My Friends',
                'btn_add_friend': 'Add', 'btn_pending': 'Pending', 'btn_accept': 'Accept', 'btn_friends': 'Friends',
                'profile_title': 'My Profile', 'profile_help': 'Help & Support', 'profile_photos': 'My Photos',
                'btn_logout': 'Logout',
                'help_title': 'Help Center', 'help_submit_ticket': 'Submit a Ticket', 'help_my_tickets': 'My Tickets',
                'placeholder_complaint': 'Describe your issue...', 'btn_submit': 'Submit',
                'ticket_status_open': 'Open', 'ticket_status_resolved': 'Resolved', 'ticket_admin_reply': 'Admin Reply:',
                'title_comments': 'Comments', 'placeholder_comment': 'Write a comment...',
                'placeholder_message': 'Type a message...',
                'btn_ok': 'OK', 'btn_cancel': 'Cancel'
            },
            'yo': { // Yoruba
                'login_title': 'Kaabo si My Space', 'login_subtitle': 'Wọle lati sopọ.',
                'signup_title': 'Ṣẹda Iwe Ipamọ Rẹ', 'signup_subtitle': 'Darapọ mọ agbegbe.',
                'nav_feed': 'Ifunni', 'nav_friends': 'Awọn ọrẹ', 'nav_messages': 'Awọn ifiranṣẹ', 'nav_profile': 'Profaili',
                'placeholder_username': 'Yan Orukọ olumulo', 'placeholder_email': 'Adirẹsi imeeli', 'placeholder_password': 'Ọrọigbaniwọle (o kere 6)',
                'btn_login': 'Wọle', 'btn_signup': 'Forukọsilẹ',
                'toggle_signup': 'Ko ni iwe ipamọ bi?', 'toggle_login': 'O ti ni iwe ipamọ tẹlẹ?',
                'create_post_title': 'Ṣẹda Ifiweranṣẹ', 'placeholder_post': 'Kini o wa ni ọkan rẹ?',
                'btn_add_photo': 'Fi Fọto kun', 'btn_post': 'Firanṣẹ',
                'story_you': 'Itan Rẹ',
                'friends_title': 'Wa Awọn ọrẹ', 'friends_requests': 'Awọn ibeere Ọrẹ', 'friends_my': 'Awọn ọrẹ Mi',
                'btn_add_friend': 'Fi kun', 'btn_pending': 'Nduro', 'btn_accept': 'Gba', 'btn_friends': 'Ọrẹ',
                'profile_title': 'Profaili Mi', 'profile_help': 'Iranlọwọ & Atilẹyin', 'profile_photos': 'Awọn fọto Mi',
                'btn_logout': 'Jade',
                'help_title': 'Ile-iṣẹ Iranlọwọ', 'help_submit_ticket': 'Fi Tiketi ranṣẹ', 'help_my_tickets': 'Awọn Tiketi Mi',
                'placeholder_complaint': 'Ṣe alaye ọrọ rẹ...', 'btn_submit': 'Firanṣẹ',
                'ticket_status_open': 'Ṣiṣi', 'ticket_status_resolved': 'Yanju', 'ticket_admin_reply': 'Idahun Abojuto:',
                'title_comments': 'Awọn asọye', 'placeholder_comment': 'Kọ asọye kan...',
                'placeholder_message': 'Kọ ifiranṣẹ kan...',
                'btn_ok': 'O DARA', 'btn_cancel': 'Fagilee'
            },
            'fr': { // French
                'login_title': 'Bienvenue sur My Space', 'login_subtitle': 'Connectez-vous.',
                'signup_title': 'Créez votre compte', 'signup_subtitle': 'Rejoignez la communauté.',
                'nav_feed': 'Fil', 'nav_friends': 'Amis', 'nav_messages': 'Messages', 'nav_profile': 'Profil',
                'placeholder_username': 'Choisissez un pseudo', 'placeholder_email': 'Adresse e-mail', 'placeholder_password': 'Mot de passe (min 6)',
                'btn_login': 'Connexion', 'btn_signup': "S'inscrire",
                'toggle_signup': 'Pas de compte?', 'toggle_login': 'Déjà un compte?',
                'create_post_title': 'Créer une publication', 'placeholder_post': 'Quoi de neuf?',
                'btn_add_photo': 'Ajouter Photo', 'btn_post': 'Publier',
                'story_you': 'Votre Story',
                'friends_title': 'Trouver des Amis', 'friends_requests': "Demandes d'amis", 'friends_my': 'Mes Amis',
                'btn_add_friend': 'Ajouter', 'btn_pending': 'En attente', 'btn_accept': 'Accepter', 'btn_friends': 'Amis',
                'profile_title': 'Mon Profil', 'profile_help': 'Aide & Support', 'profile_photos': 'Mes Photos',
                'btn_logout': 'Déconnexion',
                'help_title': "Centre d'aide", 'help_submit_ticket': 'Envoyer un ticket', 'help_my_tickets': 'Mes Tickets',
                'placeholder_complaint': 'Décrivez votre problème...', 'btn_submit': 'Envoyer',
                'ticket_status_open': 'Ouvert', 'ticket_status_resolved': 'Résolu', 'ticket_admin_reply': 'Réponse Admin:',
                'title_comments': 'Commentaires', 'placeholder_comment': 'Écrire un commentaire...',
                'placeholder_message': 'Écrire un message...',
                'btn_ok': 'OK', 'btn_cancel': 'Annuler'
            }
        };

        const translatePage = () => {
            const langDict = translations[currentLang] || translations['en'];
            $$('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (langDict[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = langDict[key];
                    } else {
                        el.textContent = langDict[key];
                    }
                }
            });
        };

        const setLanguage = async (lang) => {
            currentLang = lang;
            localStorage.setItem('my-space-lang', lang);
            if (currentUserId) {
                try {
                    const userDocRef = doc(db, 'users', currentUserId);
                    await updateDoc(userDocRef, { preferredLanguage: lang });
                } catch (e) { console.error("Could not save language preference:", e); }
            }
            translatePage();
        };

        // --- HELPER FUNCTIONS (Modals, Loaders) ---
        const showLoader = (message = '') => loadingOverlay.classList.remove('hidden');
        const hideLoader = () => loadingOverlay.classList.add('hidden');
        const showAlert = (message) => {
            $('#alert-message').textContent = message;
            alertModal.classList.remove('hidden');
        };
        const showModal = (modalEl) => modalEl.classList.remove('hidden');
        const hideModal = (modalEl) => modalEl.classList.add('hidden');

        // --- CLOUDINARY IMAGE UPLOAD ---
        const uploadImageToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error('Image upload failed.');
            const data = await response.json();
            return data.secure_url;
        };

        // --- APP INITIALIZATION ---
        function init() {
            // Check for saved language on load
            const savedLang = localStorage.getItem('my-space-lang') || 'en';
            setLanguage(savedLang);

            renderAuthPage(); // Render initial auth page
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListeners();
                setupNavListeners();
                setupModalListeners();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                authContainer.innerHTML = `<p class="text-red-500">Could not connect to services.</p>`;
            }
        }

        // --- AUTHENTICATION ---
        function setupAuthListeners() {
            onAuthStateChanged(auth, user => {
                // Detach all old listeners
                if (unsubscribeUser) unsubscribeUser();
                if (unsubscribePosts) unsubscribePosts();
                if (unsubscribeStories) unsubscribeStories();
                if (unsubscribeAllUsers) unsubscribeAllUsers();
                if (unsubscribeRequests) unsubscribeRequests();
                if (unsubscribeChats) unsubscribeChats();
                if (unsubscribeTickets) unsubscribeTickets;

                if (user) {
                    currentUserId = user.uid;
                    authContainer.classList.remove('active');
                    appContainer.classList.add('active');
                    listenToUserData(); // This will fetch user and their lang pref
                    showPage('feed'); // Default page after login
                } else {
                    currentUserId = null;
                    currentUserData = null;
                    authContainer.classList.add('active');
                    appContainer.classList.remove('active');
                    renderAuthPage(); // Re-render auth page on logout
                }
            });
        }

        const handleAuthAction = async () => {
            const email = $('#email').value, password = $('#password').value;
            const authErrorEl = $('#auth-error');
            authErrorEl.textContent = '';
            showLoader();
            try {
                if (isSignupMode) {
                    const username = $('#username').value;
                    if (username.trim().length < 3) throw new Error('Username must be at least 3 characters.');
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, 'users', userCredential.user.uid);
                    await setDoc(userDocRef, {
                        username: username,
                        email: email,
                        profilePictureUrl: `https://placehold.co/100x100/e2e8f0/cbd5e1?text=${username.charAt(0).toUpperCase()}`,
                        preferredLanguage: currentLang,
                        friends: [],
                        friendRequests: []
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authErrorEl.textContent = error.message;
            } finally {
                hideLoader();
            }
        };
        
        let isSignupMode = false;
        const toggleAuthMode = () => {
            isSignupMode = !isSignupMode;
            renderAuthPage();
        };

        // --- NAVIGATION & PAGE RENDERING ---
        function setupNavListeners() {
            $('nav').addEventListener('click', e => {
                const navBtn = e.target.closest('.nav-btn');
                if (navBtn) {
                    const page = navBtn.dataset.page;
                    showPage(page);
                }
            });
        }

        function showPage(pageId) {
            $$('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = $(`.nav-btn[data-page="${pageId}"]`);
            if(activeBtn) activeBtn.classList.add('active');
            
            // Detach old listeners before rendering new page
            stopAllPageListeners();

            if (pageId === 'feed') renderFeedPage();
            else if (pageId === 'friends') renderFriendsPage();
            else if (pageId === 'messages') renderMessagesPage();
            else if (pageId === 'profile') renderProfilePage();

            translatePage(); // Re-translate new content
        }
        
        function stopAllPageListeners() {
            // This stops all realtime listeners when changing pages
            if (unsubscribePosts) unsubscribePosts();
            if (unsubscribeStories) unsubscribeStories();
            if (unsubscribeAllUsers) unsubscribeAllUsers();
            if (unsubscribeRequests) unsubscribeRequests();
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeTickets) unsubscribeTickets;
            if (unsubscribeComments) unsubscribeComments();
            if (unsubscribeChatMessages) unsubscribeChatMessages();
            pageContent.innerHTML = ''; // Clear old content
        }

        // Render Auth Page
        function renderAuthPage() {
            authContainer.innerHTML = `
            <div class="relative w-full max-w-sm">
                <!-- Language Selector -->
                <div class="absolute top-0 right-0 p-2 z-10">
                    <select id="lang-select-auth" class="bg-transparent text-white font-medium rounded">
                        <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                        <option value="yo" ${currentLang === 'yo' ? 'selected' : ''}>Yoruba</option>
                        <option value="fr" ${currentLang === 'fr' ? 'selected' : ''}>Français</option>
                    </select>
                </div>
                
                <div class="bg-white p-8 pt-16 rounded-2xl shadow-xl relative">
                    <div class="text-center mb-6">
                        <i class="ph-bold ph-planet text-5xl text-blue-600"></i>
                        <h1 id="auth-title" class="text-2xl font-bold text-slate-800" data-lang-key="${isSignupMode ? 'signup_title' : 'login_title'}"></h1>
                        <p id="auth-subtitle" class="text-slate-500" data-lang-key="${isSignupMode ? 'signup_subtitle' : 'login_subtitle'}"></p>
                    </div>
                    <div class="space-y-4">
                        ${isSignupMode ? `<div><input type="text" id="username" data-lang-key="placeholder_username" class="w-full px-4 py-3 border border-slate-300 rounded-lg"></div>` : ''}
                        <div><input type="email" id="email" data-lang-key="placeholder_email" class="w-full px-4 py-3 border border-slate-300 rounded-lg"></div>
                        <div><input type="password" id="password" data-lang-key="placeholder_password" class="w-full px-4 py-3 border border-slate-300 rounded-lg"></div>
                        <p id="auth-error" class="text-red-500 text-sm h-4"></p>
                        <button id="auth-button" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg" data-lang-key="${isSignupMode ? 'btn_signup' : 'btn_login'}"></button>
                        <p class="text-center text-sm text-slate-500 pt-2">
                            <span data-lang-key="${isSignupMode ? 'toggle_login' : 'toggle_signup'}"></span> 
                            <a href="#" id="auth-toggle-link" class="font-semibold text-blue-600 hover:underline">${isSignupMode ? 'Login' : 'Sign Up'}</a>
                        </p>
                    </div>
                </div>
            </div>`;
            translatePage();
            // Add listeners for the newly created elements
            $('#auth-button').addEventListener('click', handleAuthAction);
            $('#auth-toggle-link').addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });
            $('#lang-select-auth').addEventListener('change', (e) => setLanguage(e.target.value));
        }

        // Render Feed Page
        function renderFeedPage() {
            pageContent.innerHTML = `
                <!-- Story Reel -->
                <div class="story-reel mb-4 bg-white p-3 rounded-lg shadow-sm">
                    <div class="story-item text-center">
                        <div class="story-avatar !bg-gray-200 relative">
                            <img src="${currentUserData?.profilePictureUrl}" alt="Your Story" class="!border-gray-200">
                            <label for="story-upload-input" class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer text-lg">+</label>
                            <input type="file" id="story-upload-input" class="hidden" accept="image/*">
                        </div>
                        <span class="text-xs font-medium" data-lang-key="story_you">Your Story</span>
                    </div>
                    <div id="stories-feed" class="flex gap-3"></div>
                </div>
                <!-- Create Post -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <h2 class="text-xl font-bold text-slate-800 mb-3" data-lang-key="create_post_title">Create a Post</h2>
                    <textarea id="post-text" class="w-full p-2 border border-slate-300 rounded-lg" rows="3" data-lang-key="placeholder_post"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <label for="post-image-input" class="file-input-label text-blue-500 hover:underline cursor-pointer" data-lang-key="btn_add_photo">Add Photo</label>
                            <input type="file" id="post-image-input" class="hidden" accept="image/*">
                            <span id="image-name" class="text-sm text-slate-500 ml-2"></span>
                        </div>
                        <button id="submit-post-btn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="btn_post">Post</button>
                    </div>
                </div>
                <!-- Post Feed -->
                <div id="post-feed" class="space-y-4"></div>
            `;
            // Add listeners for this page
            $('#story-upload-input').addEventListener('change', handleStoryUpload);
            $('#submit-post-btn').addEventListener('click', handleSubmitPost);
            $('#post-image-input').addEventListener('change', () => {
                if($('#post-image-input').files.length > 0) $('#image-name').textContent = $('#post-image-input').files[0].name;
            });
            listenToStories();
            listenToPosts();
        }

        // Render Friends Page
        function renderFriendsPage() {
            pageContent.innerHTML = `
                <h1 class="text-2xl font-bold mb-4" data-lang-key="friends_title">Find Friends</h1>
                <!-- Friend Requests -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold mb-3" data-lang-key="friends_requests">Friend Requests</h2>
                    <div id="friend-requests-list" class="space-y-2">
                        <p class="text-gray-500">No new requests.</p>
                    </div>
                </div>
                <!-- My Friends -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold mb-3" data-lang-key="friends_my">My Friends</h2>
                    <div id="my-friends-list" class="space-y-2">
                        <p class="text-gray-500">You haven't added any friends yet.</p>
                    </div>
                </div>
                <!-- All Users -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold mb-3">All Users on My Space</h2>
                    <div id="all-users-list" class="space-y-2"></div>
                </div>
            `;
            listenToAllUsers();
            listenToFriendRequests();
            listenToMyFriends();
        }

        // Render Messages Page
        function renderMessagesPage() {
            pageContent.innerHTML = `
                <h1 class="text-2xl font-bold mb-4" data-lang-key="nav_messages">Messages</h1>
                <div id="chat-list" class="space-y-2">
                    <p class="text-gray-500">Start a conversation from your friends list.</p>
                </div>
            `;
            listenToFriendsForChat();
        }
        
        // Render Profile Page
        function renderProfilePage() {
            pageContent.innerHTML = `
                <div class="relative">
                    <button id="logout-btn" class="absolute top-0 right-0 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg" data-lang-key="btn_logout">Logout</button>
                </div>
                <div class="text-center mb-6 pt-8">
                    <div class="relative w-32 h-32 mx-auto">
                        <img id="profile-page-pic" src="${currentUserData?.profilePictureUrl}" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                        <label for="profile-pic-input" class="absolute bottom-1 right-1 bg-blue-600 text-white rounded-full p-2 cursor-pointer border-2 border-white">
                            <i class="ph-bold ph-pencil-simple"></i>
                        </label>
                        <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                    </div>
                    <h1 id="profile-page-name" class="text-3xl font-bold mt-4">${currentUserData?.username}</h1>
                </div>
                
                <!-- Language & Support Section -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <!-- Language Selector -->
                    <div class="flex justify-between items-center mb-4">
                         <label for="lang-select-profile" class="font-medium">Language</label>
                         <select id="lang-select-profile" class="border border-gray-300 rounded-lg p-2">
                            <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                            <option value="yo" ${currentLang === 'yo' ? 'selected' : ''}>Yoruba</option>
                            <option value="fr" ${currentLang === 'fr' ? 'selected' : ''}>Français</option>
                         </select>
                    </div>
                    <!-- Help & Support -->
                    <button id="help-support-btn" class="w-full text-left p-2 rounded-lg hover:bg-gray-100 font-medium flex justify-between items-center" data-lang-key="profile_help">
                        <span>Help & Support</span>
                        <i class="ph ph-caret-down"></i>
                    </button>
                    <div id="help-support-section" class="hidden mt-4 pt-4 border-t">
                        <h3 class="text-lg font-semibold mb-3" data-lang-key="help_submit_ticket">Submit a Ticket</h3>
                        <textarea id="support-ticket-input" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" data-lang-key="placeholder_complaint"></textarea>
                        <button id="submit-ticket-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg mt-2" data-lang-key="btn_submit">Submit</button>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-3" data-lang-key="help_my_tickets">My Tickets</h3>
                        <div id="my-tickets-list" class="space-y-2"></div>
                    </div>
                </div>

                <h2 class="text-xl font-semibold mb-2" data-lang-key="profile_photos">My Photos</h2>
                <div id="profile-photos" class="grid grid-cols-3 gap-1 bg-white p-1 rounded-lg shadow-sm">
                    <!-- User's photo posts will be loaded here -->
                </div>
            `;
            // Add listeners
            $('#logout-btn').addEventListener('click', () => signOut(auth));
            $('#profile-pic-input').addEventListener('change', handleProfilePicUpload);
            $('#lang-select-profile').addEventListener('change', (e) => setLanguage(e.target.value));
            $('#help-support-btn').addEventListener('click', () => {
                $('#help-support-section').classList.toggle('hidden');
                if(!$('#help-support-section').classList.contains('hidden')) {
                    listenToMySupportTickets();
                } else {
                    if(unsubscribeTickets) unsubscribeTickets();
                }
            });
            $('#submit-ticket-btn').addEventListener('click', handleSubmitSupportTicket);
            listenToMyPhotos();
        }

        // --- DATA LISTENERS ---
        function listenToUserData() {
            if (unsubscribeUser) unsubscribeUser();
            const userDocRef = doc(db, 'users', currentUserId);
            unsubscribeUser = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    currentUserData = { id: doc.id, ...doc.data() };
                    // Set language from their saved preference
                    if (currentUserData.preferredLanguage && currentUserData.preferredLanguage !== currentLang) {
                        setLanguage(currentUserData.preferredLanguage);
                    }
                    // Update any visible profile info
                    const profilePic = $('#profile-page-pic');
                    if (profilePic) profilePic.src = currentUserData.profilePictureUrl;
                    const profileName = $('#profile-page-name');
                    if (profileName) profileName.textContent = currentUserData.username;
                }
            });
        };

        function listenToStories() {
            if (unsubscribeStories) unsubscribeStories();
            const storiesFeed = $('#stories-feed');
            if(!storiesFeed) return;
            
            const twentyFourHoursAgo = Timestamp.fromDate(new Date(Date.now() - 24 * 60 * 60 * 1000));
            const q = query(collection(db, 'stories'), where('createdAt', '>', twentyFourHoursAgo), orderBy('createdAt', 'desc'));
            
            unsubscribeStories = onSnapshot(q, (snapshot) => {
                storiesFeed.innerHTML = '';
                snapshot.forEach(doc => {
                    const story = doc.data();
                    if(story.authorId === currentUserId) return; // Don't show my own story in feed
                    const storyEl = document.createElement('div');
                    storyEl.className = 'story-item text-center';
                    storyEl.innerHTML = `
                        <div class="story-avatar">
                            <img src="${story.authorProfilePic}" alt="${story.authorUsername}'s Story">
                        </div>
                        <span class="text-xs font-medium">${story.authorUsername}</span>
                    `;
                    storyEl.addEventListener('click', () => viewStory(story));
                    storiesFeed.appendChild(storyEl);
                });
            });
        }

        function listenToPosts() {
            if (unsubscribePosts) unsubscribePosts();
            const postFeed = $('#post-feed');
            if(!postFeed) return;

            const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
            unsubscribePosts = onSnapshot(q, (snapshot) => {
                postFeed.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = { id: doc.id, ...doc.data() };
                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-lg shadow-sm';
                    
                    const userHasLiked = post.likes && post.likes.includes(currentUserId);
                    
                    postEl.innerHTML = `
                        <div class="flex items-center p-4">
                            <img src="${post.authorProfilePic}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <div>
                                <p class="font-bold">${post.authorUsername}</p>
                                <p class="text-xs text-slate-500">${post.createdAt?.toDate().toLocaleString()}</p>
                            </div>
                        </div>
                        <p class="px-4 mb-3 whitespace-pre-wrap">${post.text}</p>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" class="w-full max-h-[500px] object-cover">` : ''}
                        <div class="flex justify-between items-center p-4">
                            <button data-action="like" data-id="${post.id}" class="flex items-center space-x-1 ${userHasLiked ? 'text-red-500' : 'text-gray-500'}">
                                <i class="${userHasLiked ? 'ph-fill' : 'ph'} ph-heart text-2xl"></i>
                                <span class="text-sm">${post.likes?.length || 0}</span>
                            </button>
                            <button data-action="comment" data-id="${post.id}" class="flex items-center space-x-1 text-gray-500">
                                <i class="ph ph-chat-circle text-2xl"></i>
                                <span class="text-sm">${post.commentCount || 0}</span>
                            </button>
                        </div>
                    `;
                    postFeed.appendChild(postEl);
                });
            });
        }
        
        function listenToAllUsers() {
            if(unsubscribeAllUsers) unsubscribeAllUsers();
            const allUsersList = $('#all-users-list');
            if(!allUsersList) return;
            
            const q = query(collection(db, 'users'));
            unsubscribeAllUsers = onSnapshot(q, (snapshot) => {
                allUsersList.innerHTML = '';
                snapshot.forEach(doc => {
                    if (doc.id === currentUserId) return; // Don't show myself
                    const user = { id: doc.id, ...doc.data() };
                    
                    let btn = `<button data-action="add-friend" data-id="${user.id}" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full" data-lang-key="btn_add_friend">Add</button>`;
                    if(currentUserData.friends?.includes(user.id)) {
                        btn = `<button class="text-green-600 text-sm font-semibold" data-lang-key="btn_friends" disabled>Friends</button>`;
                    } else if(currentUserData.friendRequests?.includes(user.id)) {
                        btn = `<button class="text-gray-500 text-sm" data-lang-key="btn_pending" disabled>Pending</button>`;
                    } else if(user.friendRequests?.includes(currentUserId)) {
                         btn = `<button class="text-gray-500 text-sm" data-lang-key="btn_pending" disabled>Pending</button>`;
                    }

                    const userEl = document.createElement('div');
                    userEl.className = 'flex items-center justify-between p-2';
                    userEl.innerHTML = `
                        <div class="flex items-center">
                            <img src="${user.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <p class="font-medium">${user.username}</p>
                        </div>
                        ${btn}
                    `;
                    allUsersList.appendChild(userEl);
                });
                translatePage();
            });
        }
        
        function listenToFriendRequests() {
            if(unsubscribeRequests) unsubscribeRequests();
            const friendRequestsList = $('#friend-requests-list');
            if(!friendRequestsList || !currentUserData.friendRequests || currentUserData.friendRequests.length === 0) {
                if(friendRequestsList) friendRequestsList.innerHTML = `<p class="text-gray-500 text-sm">No new requests.</p>`;
                return;
            }
            
            const q = query(collection(db, 'users'), where('__name__', 'in', currentUserData.friendRequests));
            unsubscribeRequests = onSnapshot(q, (snapshot) => {
                friendRequestsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const userEl = document.createElement('div');
                    userEl.className = 'flex items-center justify-between p-2';
                    userEl.innerHTML = `
                        <div class="flex items-center">
                            <img src="${user.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <p class="font-medium">${user.username}</p>
                        </div>
                        <button data-action="accept-friend" data-id="${user.id}" class="bg-green-500 text-white text-sm py-1 px-3 rounded-full" data-lang-key="btn_accept">Accept</button>
                    `;
                    friendRequestsList.appendChild(userEl);
                });
                translatePage();
            });
        }
        
        function listenToMyFriends() {
            if(unsubscribeChats) unsubscribeChats(); // Re-use this listener name
            const myFriendsList = $('#my-friends-list');
            if(!myFriendsList || !currentUserData.friends || currentUserData.friends.length === 0) {
                 if(myFriendsList) myFriendsList.innerHTML = `<p class="text-gray-500 text-sm">You haven't added any friends yet.</p>`;
                return;
            }
            
            const q = query(collection(db, 'users'), where('__name__', 'in', currentUserData.friends));
            unsubscribeChats = onSnapshot(q, (snapshot) => {
                myFriendsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const friendEl = document.createElement('div');
                    friendEl.className = 'flex items-center p-2';
                    friendEl.innerHTML = `
                        <img src="${user.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3 object-cover">
                        <p class="font-medium">${user.username}</p>
                    `;
                    myFriendsList.appendChild(friendEl);
                });
            });
        }
        
        function listenToFriendsForChat() {
            // This is the same as listenToMyFriends, but renders for chat
            if(unsubscribeChats) unsubscribeChats();
            const chatList = $('#chat-list');
            if(!chatList || !currentUserData.friends || currentUserData.friends.length === 0) {
                 if(chatList) chatList.innerHTML = `<p class="text-gray-500">Add friends to start chatting.</p>`;
                return;
            }
            
            const q = query(collection(db, 'users'), where('__name__', 'in', currentUserData.friends));
            unsubscribeChats = onSnapshot(q, (snapshot) => {
                chatList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const chatEl = document.createElement('div');
                    chatEl.className = 'flex items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-50';
                    chatEl.innerHTML = `
                        <img src="${user.profilePictureUrl}" class="w-12 h-12 rounded-full mr-3 object-cover">
                        <p class="font-medium text-lg">${user.username}</p>
                    `;
                    chatEl.addEventListener('click', () => openChat(user.id, user.username));
                    chatList.appendChild(chatEl);
                });
            });
        }
        
        function listenToMyPhotos() {
            // Re-using unsubscribePosts is fine as it's on a different page
            if (unsubscribePosts) unsubscribePosts();
            const profilePhotos = $('#profile-photos');
            if(!profilePhotos) return;

            const q = query(collection(db, 'posts'), where('authorId', '==', currentUserId), where('imageUrl', '!=', null), orderBy('imageUrl'), orderBy('createdAt', 'desc'));
            unsubscribePosts = onSnapshot(q, (snapshot) => {
                profilePhotos.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const photoEl = document.createElement('div');
                    photoEl.className = 'w-full aspect-square bg-gray-200 rounded';
                    photoEl.innerHTML = `<img src="${post.imageUrl}" class="w-full h-full object-cover rounded">`;
                    profilePhotos.appendChild(photoEl);
                });
            });
        }
        
        function listenToMySupportTickets() {
            if(unsubscribeTickets) unsubscribeTickets();
            const ticketsList = $('#my-tickets-list');
            if(!ticketsList) return;
            
            const q = query(collection(db, 'support_tickets'), where('userId', '==', currentUserId), orderBy('createdAt', 'desc'));
            unsubscribeTickets = onSnapshot(q, (snapshot) => {
                ticketsList.innerHTML = '';
                if(snapshot.empty) {
                    ticketsList.innerHTML = '<p class="text-gray-500 text-sm">No tickets submitted.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    const ticketEl = document.createElement('div');
                    ticketEl.className = 'p-3 bg-gray-100 rounded-lg';
                    ticketEl.innerHTML = `
                        <p class="text-sm text-gray-500">${ticket.createdAt.toDate().toLocaleDateString()}</p>
                        <p class="font-medium">${ticket.message}</p>
                        <p class="text-sm font-semibold mt-2 ${ticket.status === 'resolved' ? 'text-green-600' : 'text-yellow-600'}">
                            Status: <span data-lang-key="ticket_status_${ticket.status}">${ticket.status}</span>
                        </p>
                        ${ticket.adminReply ? `
                            <div class="mt-2 pt-2 border-t border-gray-300">
                                <p class="font-bold text-sm" data-lang-key="ticket_admin_reply">Admin Reply:</p>
                                <p class="text-sm">${ticket.adminReply}</p>
                            </div>
                        ` : ''}
                    `;
                    ticketsList.appendChild(ticketEl);
                });
                translatePage();
            });
        }

        // --- CORE ACTION HANDLERS ---
        const handleStoryUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoader();
            try {
                const imageUrl = await uploadImageToCloudinary(file);
                await addDoc(collection(db, 'stories'), {
                    imageUrl: imageUrl,
                    authorId: currentUserId,
                    authorUsername: currentUserData.username,
                    authorProfilePic: currentUserData.profilePictureUrl,
                    createdAt: serverTimestamp()
                });
                showAlert("Story posted!");
            } catch (error) {
                console.error(error);
                showAlert("Could not post story.");
            } finally {
                hideLoader();
            }
        };

        const viewStory = (story) => {
            $('#story-image').src = story.imageUrl;
            showModal(storyViewerModal);
            // Simple timeout to close modal
            setTimeout(() => {
                hideModal(storyViewerModal);
            }, 5000); // Show story for 5 seconds
        };
        
        const handleSubmitPost = async () => {
            const text = $('#post-text').value.trim();
            const file = $('#post-image-input').files[0];
            if (!text && !file) return;
            showLoader();
            try {
                let imageUrl = null;
                if (file) {
                    imageUrl = await uploadImageToCloudinary(file);
                }
                await addDoc(collection(db, 'posts'), {
                    text: text,
                    imageUrl: imageUrl,
                    authorId: currentUserId,
                    authorUsername: currentUserData.username,
                    authorProfilePic: currentUserData.profilePictureUrl,
                    createdAt: serverTimestamp(),
                    likes: [],
                    commentCount: 0
                });
                $('#post-text').value = '';
                $('#post-image-input').value = '';
                $('#image-name').textContent = '';
            } catch (error) {
                console.error(error);
                showAlert('Could not create post.');
            } finally {
                hideLoader();
            }
        };
        
        const handleLikePost = async (postId) => {
            const postRef = doc(db, 'posts', postId);
            try {
                await runTransaction(db, async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    if (!postDoc.exists()) throw "Document does not exist!";
                    
                    const postData = postDoc.data();
                    const likes = postData.likes || [];
                    let newLikes;
                    if (likes.includes(currentUserId)) {
                        newLikes = likes.filter(id => id !== currentUserId);
                    } else {
                        newLikes = [...likes, currentUserId];
                    }
                    transaction.update(postRef, { likes: newLikes });
                });
            } catch (e) {
                console.error("Like transaction failed: ", e);
            }
        };

        const handleOpenComments = (postId) => {
            currentOpenPostId = postId;
            showModal(commentModal);
            const commentList = $('#comment-list');
            commentList.innerHTML = '<p>Loading...</p>';
            
            if(unsubscribeComments) unsubscribeComments();
            const q = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'asc'));
            unsubscribeComments = onSnapshot(q, (snapshot) => {
                commentList.innerHTML = '';
                if(snapshot.empty) {
                    commentList.innerHTML = '<p class="text-gray-500 text-sm">No comments yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = 'p-2 bg-gray-100 rounded-lg';
                    commentEl.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${comment.authorProfilePic}" class="w-6 h-6 rounded-full object-cover">
                            <span class="font-semibold text-sm">${comment.authorUsername}</span>
                        </div>
                        <p class="pl-8 text-sm">${comment.text}</p>
                    `;
                    commentList.appendChild(commentEl);
                });
            });
        };
        
        const handleSubmitComment = async () => {
            const text = $('#comment-input').value.trim();
            if(!text || !currentOpenPostId) return;
            
            try {
                // Add the comment
                const commentRef = await addDoc(collection(db, 'posts', currentOpenPostId, 'comments'), {
                    text: text,
                    authorId: currentUserId,
                    authorUsername: currentUserData.username,
                    authorProfilePic: currentUserData.profilePictureUrl,
                    createdAt: serverTimestamp()
                });
                
                // Update the comment count on the post
                const postRef = doc(db, 'posts', currentOpenPostId);
                await runTransaction(db, async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    const currentCount = postDoc.data().commentCount || 0;
                    transaction.update(postRef, { commentCount: currentCount + 1 });
                });
                
                $('#comment-input').value = '';
                // Don't hide modal, let user see their comment appear
            } catch(e) {
                console.error("Error adding comment: ", e);
                showAlert("Could not post comment.");
            }
        };
        
        const handleProfilePicUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoader();
            try {
                const imageUrl = await uploadImageToCloudinary(file);
                const userDocRef = doc(db, 'users', currentUserId);
                await updateDoc(userDocRef, { profilePictureUrl: imageUrl });
                showAlert('Profile picture updated!');
            } catch (error) {
                showAlert('Upload failed. Please try again.');
            } finally {
                hideLoader();
            }
        };
        
        const handleSendFriendRequest = async (targetUserId) => {
            try {
                const targetUserRef = doc(db, 'users', targetUserId);
                await updateDoc(targetUserRef, {
                    friendRequests: arrayUnion(currentUserId)
                });
                // Update button state (optimistic update)
                const btn = $(`[data-id="${targetUserId}"][data-action="add-friend"]`);
                if(btn) {
                    btn.textContent = 'Pending';
                    btn.disabled = true;
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('text-gray-500');
                }
            } catch(e) {
                console.error(e);
                showAlert("Could not send friend request.");
            }
        };
        
        const handleAcceptFriendRequest = async (requestingUserId) => {
            try {
                const batch = writeBatch(db);
                
                // Add to my friends list and remove from my requests
                const myRef = doc(db, 'users', currentUserId);
                batch.update(myRef, {
                    friends: arrayUnion(requestingUserId),
                    friendRequests: arrayRemove(requestingUserId)
                });
                
                // Add me to their friends list
                const theirRef = doc(db, 'users', requestingUserId);
                batch.update(theirRef, {
                    friends: arrayUnion(currentUserId)
                });
                
                await batch.commit();
            } catch(e) {
                console.error(e);
                showAlert("Could not accept friend request.");
            }
        };
        
        const handleSubmitSupportTicket = async () => {
            const message = $('#support-ticket-input').value.trim();
            if(!message) return;
            
            try {
                await addDoc(collection(db, 'support_tickets'), {
                    userId: currentUserId,
                    userEmail: currentUserData.email,
                    message: message,
                    status: 'open',
                    adminReply: '',
                    createdAt: serverTimestamp()
                });
                $('#support-ticket-input').value = '';
                showAlert("Support ticket submitted.");
            } catch(e) {
                console.error(e);
                showAlert("Could not submit ticket.");
            }
        };
        
        const openChat = (friendId, friendName) => {
            currentOpenChatId = [currentUserId, friendId].sort().join('_');
            $('#chat-with-name').textContent = `Chat with ${friendName}`;
            showModal(chatModal);
            
            const chatMessages = $('#chat-messages');
            chatMessages.innerHTML = '';
            
            if(unsubscribeChatMessages) unsubscribeChatMessages();
            const q = query(collection(db, 'chats', currentOpenChatId, 'messages'), orderBy('createdAt', 'asc'));
            
            unsubscribeChatMessages = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgEl = document.createElement('div');
                    msgEl.className = `p-3 rounded-lg max-w-[80%] break-words ${msg.senderId === currentUserId ? 'bg-blue-600 text-white self-end' : 'bg-gray-200 text-gray-800 self-start'}`;
                    msgEl.textContent = msg.text;
                    chatMessages.appendChild(msgEl);
                });
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        };
        
        const handleSendMessage = async () => {
            const text = $('#chat-input').value.trim();
            if(!text || !currentOpenChatId) return;
            
            const tempInput = $('#chat-input');
            tempInput.value = ''; // Clear input immediately
            
            try {
                await addDoc(collection(db, 'chats', currentOpenChatId, 'messages'), {
                    text: text,
                    senderId: currentUserId,
                    createdAt: serverTimestamp()
                });
            } catch(e) {
                console.error(e);
                tempInput.value = text; // Put text back if send fails
            }
        };

        // --- GLOBAL EVENT LISTENERS (Using Event Delegation) ---
        function setupModalListeners() {
            $('#alert-ok-btn').addEventListener('click', () => hideModal(alertModal));
            
            $('#comment-cancel-btn').addEventListener('click', ()D {
                hideModal(commentModal);
                if(unsubscribeComments) unsubscribeComments();
                currentOpenPostId = null;
            });
            $('#comment-submit-btn').addEventListener('click', handleSubmitComment);
            
            $('#story-close-btn').addEventListener('click', () => hideModal(storyViewerModal));
            
            $('#chat-close-btn').addEventListener('click', () => {
                hideModal(chatModal);
                if(unsubscribeChatMessages) unsubscribeChatMessages();
                currentOpenChatId = null;
            });
            $('#chat-send-btn').addEventListener('click', handleSendMessage);
        }
        
        // This single listener on pageContent handles clicks for posts, friends, etc.
        pageContent.addEventListener('click', (e) => {
            const action = e.target.closest('[data-action]');
            if (!action) return;

            const id = action.dataset.id;
            switch(action.dataset.action) {
                case 'like':
                    handleLikePost(id);
                    break;
                case 'comment':
                    handleOpenComments(id);
                    break;
                case 'add-friend':
                    handleSendFriendRequest(id);
                    break;
                case 'accept-friend':
                    handleAcceptFriendRequest(id);
                    break;
            }
        });
        
        // --- START THE APP ---
        init();

    </script>
</body>
</html>


